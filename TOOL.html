<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت حافظه مرورگر</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Vazirmatn for Persian UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #161b22;
        }
        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* Custom Loader Animation */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0d1117;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
        }
        .loader {
            border: 4px solid #30363d;
            border-top: 4px solid #58a6ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pretty-print JSON styling */
        pre.json-formatter {
            background-color: #161b22;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #30363d;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .json-formatter .string { color: #a5d6ff; }
        .json-formatter .number { color: #79c0ff; }
        .json-formatter .boolean { color: #ffab70; }
        .json-formatter .null { color: #ff7b72; }
        .json-formatter .key { color: #d2a8ff; }

        /* Smooth transition for elements */
        .storage-card {
            transition: all 0.3s ease-in-out;
        }

        /* Custom modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loader -->
    <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div>

    <!-- Main Container -->
    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8 opacity-0 transition-opacity duration-500">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <div>
                <h1 class="text-3xl font-bold text-white">ابزار مدیریت حافظه مرورگر</h1>
                <p class="text-sm text-gray-400 mt-2">مشاهده، ویرایش و مدیریت LocalStorage، SessionStorage، Cookies و IndexedDB</p>
            </div>
            <div class="flex items-center space-x-2 space-x-reverse mt-4 sm:mt-0">
                <button id="backupBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    تهیه پشتیبان
                </button>
                <button id="restoreBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414l-3-3z" clip-rule="evenodd" /></svg>
                    بازیابی
                </button>
                <input type="file" id="restoreFile" class="hidden" accept=".json">
            </div>
        </header>

        <main>
             <!-- Security Note -->
            <div class="bg-yellow-900/30 border border-yellow-700 text-yellow-300 px-4 py-3 rounded-lg relative mb-6" role="alert">
              <strong class="font-bold">نکته مهم امنیتی:</strong>
              <span class="block sm:inline"> این ابزار به دلیل سیاست‌های امنیتی مرورگرها (Same-Origin Policy)، تنها به داده‌های ذخیره شده برای **همین دامنه (صفحه فعلی)** دسترسی دارد و نمی‌تواند داده‌های وب‌سایت‌های دیگر را نمایش دهد.</span>
            </div>

            <!-- Content Area -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Local Storage -->
                <section id="localStorageSection">
                    <h2 class="text-2xl font-semibold mb-4 text-white flex items-center">
                        <svg class="w-6 h-6 ml-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                        LocalStorage
                    </h2>
                    <div id="localStorageContent" class="space-y-3"></div>
                </section>

                <!-- Session Storage -->
                <section id="sessionStorageSection">
                    <h2 class="text-2xl font-semibold mb-4 text-white flex items-center">
                        <svg class="w-6 h-6 ml-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        SessionStorage
                    </h2>
                    <div id="sessionStorageContent" class="space-y-3"></div>
                </section>

                <!-- Cookies -->
                <section id="cookiesSection" class="lg:col-span-2">
                    <h2 class="text-2xl font-semibold mb-4 text-white flex items-center">
                        <svg class="w-6 h-6 ml-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Cookies
                    </h2>
                    <div id="cookiesContent" class="space-y-3"></div>
                </section>

                 <!-- IndexedDB -->
                <section id="indexedDbSection" class="lg:col-span-2">
                    <h2 class="text-2xl font-semibold mb-4 text-white flex items-center">
                        <svg class="w-6 h-6 ml-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7s-4 4 0 4s4-4 4-4s4 4 4 4"></path></svg>
                        IndexedDB
                    </h2>
                    <div id="indexedDbContent" class="space-y-4"></div>
                </section>

            </div>
        </main>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">
        <div class="bg-[#161b22] rounded-lg shadow-xl w-11/12 max-w-2xl border border-gray-700 transform transition-all scale-95 opacity-0">
            <div class="flex justify-between items-center p-4 border-b border-gray-600">
                <h3 class="text-xl font-semibold text-white">ویرایش داده</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-1">کلید (Key)</label>
                    <input type="text" id="editKey" class="w-full bg-[#0d1117] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">مقدار (Value)</label>
                    <textarea id="editValue" rows="8" class="w-full bg-[#0d1117] border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono"></textarea>
                </div>
            </div>
            <div class="flex justify-end p-4 bg-[#0d1117] rounded-b-lg space-x-2 space-x-reverse">
                <button id="cancelEditBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">لغو</button>
                <button id="saveEditBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">ذخیره تغییرات</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-3 transition-all duration-300 border border-gray-600">
       <p id="toastMessage"></p>
    </div>


    <script type="module">
        // --- UTILITY FUNCTIONS ---
        
        // Pretty-prints JSON strings for better readability
        function formatJson(jsonString) {
            try {
                const obj = JSON.parse(jsonString);
                const html = JSON.stringify(obj, null, 2)
                    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
                        let cls = 'number';
                        if (/^"/.test(match)) {
                            if (/:$/.test(match)) {
                                cls = 'key';
                            } else {
                                cls = 'string';
                            }
                        } else if (/true|false/.test(match)) {
                            cls = 'boolean';
                        } else if (/null/.test(match)) {
                            cls = 'null';
                        }
                        return `<span class="${cls}">${match}</span>`;
                    });
                return `<pre class="json-formatter">${html}</pre>`;
            } catch (e) {
                // Return as plain text if it's not valid JSON
                return `<div class="text-gray-300">${jsonString.replace(/</g, "&lt;")}</div>`;
            }
        }

        // Creates a data card element for display
        function createCard(type, key, value, onDelete, onEdit) {
            const card = document.createElement('div');
            card.className = 'storage-card bg-[#161b22] p-4 rounded-lg border border-gray-700 hover:border-blue-500 hover:shadow-lg';
            
            const valueContent = formatJson(value);

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <strong class="text-blue-400 font-mono break-all">${key}</strong>
                    <div class="flex space-x-2 space-x-reverse flex-shrink-0 ml-4">
                        <button class="edit-btn text-yellow-400 hover:text-yellow-300" title="ویرایش">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                        </button>
                        <button class="delete-btn text-red-500 hover:text-red-400" title="حذف">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="mt-3 value-container">${valueContent}</div>
            `;

            card.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                onDelete(key);
            });
            card.querySelector('.edit-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                onEdit(type, key, value);
            });
            return card;
        }

        // Shows a toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = toast.className.replace(/bg-.*-600/, `bg-${type === 'success' ? 'green' : 'red'}-600`);
            toast.classList.remove('opacity-0', 'translate-y-3');
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-3');
            }, 3000);
        }

        // --- DATA HANDLING FUNCTIONS ---

        // Load and display data from LocalStorage
        function loadLocalStorage() {
            const container = document.getElementById('localStorageContent');
            container.innerHTML = '';
            if (localStorage.length === 0) {
                container.innerHTML = '<p class="text-gray-400">هیچ داده‌ای در LocalStorage یافت نشد.</p>';
                return;
            }
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const card = createCard(
                    'localStorage', 
                    key, 
                    value,
                    (k) => { localStorage.removeItem(k); refreshAll(); showToast(`'${k}' با موفقیت حذف شد.`); },
                    openEditModal
                );
                container.appendChild(card);
            }
        }

        // Load and display data from SessionStorage
        function loadSessionStorage() {
            const container = document.getElementById('sessionStorageContent');
            container.innerHTML = '';
            if (sessionStorage.length === 0) {
                container.innerHTML = '<p class="text-gray-400">هیچ داده‌ای در SessionStorage یافت نشد.</p>';
                return;
            }
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                const value = sessionStorage.getItem(key);
                const card = createCard(
                    'sessionStorage', 
                    key, 
                    value,
                    (k) => { sessionStorage.removeItem(k); refreshAll(); showToast(`'${k}' با موفقیت حذف شد.`); },
                    openEditModal
                );
                container.appendChild(card);
            }
        }

        // Load and display data from Cookies
        function loadCookies() {
            const container = document.getElementById('cookiesContent');
            container.innerHTML = '';
            const cookies = document.cookie.split(';').filter(c => c.trim() !== '');
            if (cookies.length === 0) {
                container.innerHTML = '<p class="text-gray-400">هیچ کوکی‌ای یافت نشد.</p>';
                return;
            }
            cookies.forEach(cookie => {
                const [key, value] = cookie.split('=').map(c => c.trim());
                const card = createCard(
                    'cookie',
                    key, 
                    decodeURIComponent(value),
                    (k) => { 
                        document.cookie = `${k}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                        refreshAll(); 
                        showToast(`کوکی '${k}' با موفقیت حذف شد.`);
                    },
                    openEditModal
                );
                container.appendChild(card);
            });
        }
        
        // --- IndexedDB HANDLING ---
        async function getIndexedDbData() {
            const dbs = await window.indexedDB.databases();
            if (!dbs || dbs.length === 0) return {};

            const allData = {};
            for (const dbInfo of dbs) {
                try {
                    const db = await new Promise((resolve, reject) => {
                        const request = indexedDB.open(dbInfo.name, dbInfo.version);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                    
                    const storeNames = Array.from(db.objectStoreNames);
                    allData[db.name] = {};

                    for (const storeName of storeNames) {
                        allData[db.name][storeName] = await new Promise((resolve, reject) => {
                            const transaction = db.transaction(storeName, 'readonly');
                            const store = transaction.objectStore(storeName);
                            const request = store.getAll();
                            request.onsuccess = () => resolve(request.result);
                            request.onerror = () => reject(request.error);
                        });
                    }
                    db.close();
                } catch (e) {
                    console.error(`Could not read IndexedDB: ${dbInfo.name}`, e);
                    allData[dbInfo.name] = { error: `دسترسی به این دیتابیس ممکن نیست. ${e.message}`};
                }
            }
            return allData;
        }

        async function loadIndexedDB() {
            const container = document.getElementById('indexedDbContent');
            container.innerHTML = '<p class="text-gray-400">در حال بارگذاری داده‌های IndexedDB...</p>';
            
            try {
                const dbs = await window.indexedDB.databases();
                 if (!dbs || dbs.length === 0) {
                    container.innerHTML = '<p class="text-gray-400">هیچ دیتابیس IndexedDB یافت نشد.</p>';
                    return;
                }
                container.innerHTML = '';

                for (const dbInfo of dbs) {
                     const dbContainer = document.createElement('div');
                     dbContainer.className = 'bg-[#161b22] p-4 rounded-lg border border-gray-700';
                     dbContainer.innerHTML = `<h3 class="text-xl font-bold text-red-300 mb-3">${dbInfo.name} (v${dbInfo.version})</h3>`;
                     
                     const storesContainer = document.createElement('div');
                     storesContainer.className = 'space-y-3';
                     dbContainer.appendChild(storesContainer);
                     container.appendChild(dbContainer);

                     try {
                        const db = await new Promise((resolve, reject) => {
                            const request = indexedDB.open(dbInfo.name, dbInfo.version);
                            request.onsuccess = e => resolve(e.target.result);
                            request.onerror = e => reject(e.target.error);
                        });

                        const storeNames = Array.from(db.objectStoreNames);
                        if(storeNames.length === 0){
                           storesContainer.innerHTML = '<p class="text-gray-400 text-sm">هیچ Object Store یافت نشد.</p>';
                        }

                        for (const storeName of storeNames) {
                            const transaction = db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            const keyPath = store.keyPath;

                            const storeEl = document.createElement('div');
                            storeEl.innerHTML = `<h4 class="text-lg font-semibold text-gray-300 mb-2">${storeName}</h4>`;
                            const itemsContainer = document.createElement('div');
                            itemsContainer.className = 'space-y-2 pl-4 border-r-2 border-gray-600';
                            storeEl.appendChild(itemsContainer);
                            
                            const request = store.getAll();
                            request.onsuccess = () => {
                                if(request.result.length === 0) {
                                   itemsContainer.innerHTML = '<p class="text-gray-400 text-sm">این Object Store خالی است.</p>'
                                }
                                request.result.forEach(item => {
                                    const key = Array.isArray(keyPath) 
                                        ? keyPath.map(k => item[k]).join(', ') 
                                        : item[keyPath] || 'Auto-generated Key';

                                    const itemCard = createCard(
                                        `indexedDB.${db.name}.${storeName}`,
                                        key,
                                        JSON.stringify(item),
                                        (k) => { 
                                            /* Delete logic is complex and needs key. Skipping direct UI delete for simplicity. 
                                            Users can clear via dev tools or restore functionality can overwrite. */ 
                                            showToast('حذف آیتم‌های IndexedDB از این طریق پشتیبانی نمی‌شود.', 'error');
                                        },
                                        openEditModal
                                    );
                                    // Disable editing for IndexedDB for now due to complexity
                                    itemCard.querySelector('.edit-btn').disabled = true;
                                    itemCard.querySelector('.edit-btn').classList.add('opacity-50', 'cursor-not-allowed');
                                    itemsContainer.appendChild(itemCard);
                                });
                            };
                            storesContainer.appendChild(storeEl);
                        }
                         db.close();
                     } catch(e) {
                         console.error(e);
                         storesContainer.innerHTML = `<p class="text-red-400">خطا در خواندن Object Stores: ${e.message}</p>`;
                     }
                }

            } catch (e) {
                container.innerHTML = `<p class="text-red-400">خطا در دسترسی به IndexedDB. ممکن است مرورگر شما از این API پشتیبانی نکند. ${e.message}</p>`;
            }
        }


        // Refresh all data displays
        function refreshAll() {
            loadLocalStorage();
            loadSessionStorage();
            loadCookies();
            loadIndexedDB();
        }


        // --- MODAL LOGIC ---
        const modal = document.getElementById('editModal');
        const modalContent = modal.querySelector('div');
        const closeBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelEditBtn');
        const saveBtn = document.getElementById('saveEditBtn');
        const editKeyInput = document.getElementById('editKey');
        const editValueTextarea = document.getElementById('editValue');
        let currentEditContext = {};

        function openEditModal(type, key, value) {
            currentEditContext = { type, key, value };
            editKeyInput.value = key;
            try {
                // Try to pretty-print JSON for editing
                editValueTextarea.value = JSON.stringify(JSON.parse(value), null, 2);
            } catch (e) {
                editValueTextarea.value = value;
            }
            
            editValueTextarea.readOnly = type.startsWith('indexedDB'); // Make IndexedDB read-only for now
            if (editValueTextarea.readOnly) {
                saveBtn.classList.add('hidden');
            } else {
                 saveBtn.classList.remove('hidden');
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeEditModal() {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
        }

        function saveEdit() {
            const { type, key } = currentEditContext;
            let newValue = editValueTextarea.value;
            
            // Validate JSON if needed
            try {
                JSON.parse(newValue);
            } catch(e) {
                if(confirm("مقدار وارد شده یک JSON معتبر نیست. آیا مطمئن هستید که می‌خواهید آن را به صورت متن ساده ذخیره کنید؟")) {
                    // proceed
                } else {
                    return;
                }
            }

            switch (type) {
                case 'localStorage':
                    localStorage.setItem(key, newValue);
                    break;
                case 'sessionStorage':
                    sessionStorage.setItem(key, newValue);
                    break;
                case 'cookie':
                    document.cookie = `${key}=${encodeURIComponent(newValue)}; path=/; max-age=31536000`;
                    break;
                // IndexedDB editing is complex and not implemented here
            }
            showToast(`مقدار '${key}' با موفقیت به‌روزرسانی شد.`);
            refreshAll();
            closeEditModal();
        }
        
        closeBtn.addEventListener('click', closeEditModal);
        cancelBtn.addEventListener('click', closeEditModal);
        saveBtn.addEventListener('click', saveEdit);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeEditModal();
        });


        // --- BACKUP & RESTORE LOGIC ---
        
        async function backupData() {
            showToast('در حال آماده‌سازی فایل پشتیبان...', 'info');
            try {
                const backup = {
                    localStorage: {},
                    sessionStorage: {},
                    cookies: {},
                    indexedDB: {}
                };

                // Backup LocalStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    backup.localStorage[key] = localStorage.getItem(key);
                }

                // Backup SessionStorage
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    backup.sessionStorage[key] = sessionStorage.getItem(key);
                }
                
                // Backup Cookies
                document.cookie.split(';').forEach(c => {
                    if(c.trim()){
                        const [key, value] = c.split('=').map(s => s.trim());
                        backup.cookies[key] = decodeURIComponent(value);
                    }
                });

                // Backup IndexedDB
                backup.indexedDB = await getIndexedDbData();

                // Create and download file
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `browser_storage_backup_${new Date().toISOString()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('فایل پشتیبان با موفقیت دانلود شد.');
            } catch (e) {
                console.error("Backup failed:", e);
                showToast('خطا در تهیه پشتیبان!', 'error');
            }
        }
        
        async function restoreData(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!confirm("هشدار! تمام داده‌های فعلی پاک شده و با اطلاعات فایل پشتیبان جایگزین خواهند شد. آیا ادامه می‌دهید؟")) {
                        return;
                    }

                    showToast('در حال بازیابی اطلاعات...', 'info');

                    // Clear existing data
                    localStorage.clear();
                    sessionStorage.clear();
                    // Note: clearing all cookies and indexedDB is more complex, restore will overwrite
                    
                    // Restore LocalStorage
                    if (data.localStorage) {
                        Object.keys(data.localStorage).forEach(key => localStorage.setItem(key, data.localStorage[key]));
                    }
                    
                    // Restore SessionStorage
                    if (data.sessionStorage) {
                        Object.keys(data.sessionStorage).forEach(key => sessionStorage.setItem(key, data.sessionStorage[key]));
                    }

                    // Restore Cookies
                    if (data.cookies) {
                        Object.keys(data.cookies).forEach(key => {
                            document.cookie = `${key}=${encodeURIComponent(data.cookies[key])}; path=/; max-age=31536000`;
                        });
                    }
                    
                    // Restore IndexedDB
                    if(data.indexedDB) {
                        for (const dbName in data.indexedDB) {
                           try {
                                const db = await new Promise((res, rej) => {
                                   const req = indexedDB.open(dbName);
                                   req.onsuccess = () => res(req.result);
                                   req.onerror = () => rej(req.error);
                                });
                                for(const storeName in data.indexedDB[dbName]) {
                                    const transaction = db.transaction(storeName, 'readwrite');
                                    const store = transaction.objectStore(storeName);
                                    store.clear(); // Clear old data
                                    data.indexedDB[dbName][storeName].forEach(item => {
                                        store.add(item);
                                    });
                                }
                                db.close();
                           } catch (err) {
                               console.error(`Failed to restore DB: ${dbName}`, err);
                               showToast(`خطا در بازیابی دیتابیس ${dbName}`, 'error');
                           }
                        }
                    }
                    
                    showToast('بازیابی با موفقیت انجام شد. صفحه دوباره بارگذاری می‌شود.');
                    setTimeout(() => window.location.reload(), 2000);
                    
                } catch (err) {
                    console.error("Restore failed:", err);
                    showToast('فایل پشتیبان نامعتبر است یا در هنگام بازیابی خطا رخ داد.', 'error');
                }
            };
            reader.readAsText(file);
        }

        document.getElementById('backupBtn').addEventListener('click', backupData);
        document.getElementById('restoreBtn').addEventListener('click', () => document.getElementById('restoreFile').click());
        document.getElementById('restoreFile').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                restoreData(e.target.files[0]);
                e.target.value = ''; // Reset file input
            }
        });


        // --- INITIALIZATION ---
        function init() {
            // Add some dummy data for demonstration if storage is empty
            if (localStorage.length === 0 && sessionStorage.length === 0) {
                localStorage.setItem('theme', 'dark');
                localStorage.setItem('user_prefs', JSON.stringify({ notifications: true, language: 'fa' }));
                sessionStorage.setItem('session_id', 'xyz-123-abc');
                document.cookie = "track_consent=true; path=/; max-age=31536000";
            }
            
            // Create a demo IndexedDB
            const request = indexedDB.open("DemoDB", 1);
            request.onupgradeneeded = event => {
                const db = event.target.result;
                const objectStore = db.createObjectStore("items", { keyPath: "id", autoIncrement: true });
                objectStore.createIndex("name", "name", { unique: false });
                objectStore.transaction.oncomplete = () => {
                    const itemStore = db.transaction("items", "readwrite").objectStore("items");
                    itemStore.add({ name: "نمونه محصول ۱", price: 100 });
                    itemStore.add({ name: "یادداشت نمونه", content: "این یک تست است" });
                };
            };
            
            // Hide loader and show app
            const loader = document.getElementById('loader');
            const app = document.getElementById('app');
            setTimeout(() => {
                loader.style.opacity = '0';
                app.style.opacity = '1';
                setTimeout(() => loader.style.display = 'none', 500);
                 // Initial data load
                refreshAll();
            }, 1000); // Simulate loading time
        }

        init();
    </script>
</body>
</html>